import{a4 as J,a5 as Z,d as Q,E as X,c as Y}from"./el-button-BPh_G9Ns.js";import{E as ee}from"./el-card-WJRpVXyY.js";/* empty css                 */import{E as te}from"./el-empty-CTH9Xt6a.js";import{E as se}from"./el-avatar-BX8gO55S.js";import{_ as ae,h as oe,g as k,A as le,B as ne,a as B,j as g,w as T,o as w,i as t,u as C,b as R,l as re,e as K,n as U,t as j,F as ie,k as ue,O as ce,P as de,Z as ve,L as fe}from"./index-DoZiZmvY.js";import{m as A}from"./marked.esm-CZs8RSRt.js";import{u as me}from"./aimessage-BCaohSPm.js";const ge=({id:$,userMessage:S})=>fetch("http://localhost:9000/common/chat/stream",{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify({id:$,userMessage:S})}).then(s=>{if(!s.ok)throw new Error(`HTTP error! Status: ${s.status}`);return s}),q="/assets/ai-avatar-Cuoi8xER.png",pe={class:"ai-page"},he={class:"chat-header"},_e={class:"header-title"},ye={class:"status-actions"},xe={key:0,class:"empty-state"},be={class:"chat-suggestions"},ke={class:"suggestion-items"},we={class:"avatar"},Ee={class:"message-content"},Me=["innerHTML"],Te={class:"chat-footer"},Ce={class:"circle-button"},Se={__name:"AiPage",setup($){A.setOptions({gfm:!0,breaks:!0,headerIds:!1,mangle:!1,smartLists:!0,smartypants:!0,xhtml:!1,highlight:function(h,e){return`<pre class="language-${e}"><code>${h}</code></pre>`}});const S=oe(),_=me(),n=k(""),s=k(!1),a=k([]),u=k(null),H=k(!1),c=k(!1);let d=null;const z=()=>{if(!u.value)return;const{scrollTop:h,scrollHeight:e,clientHeight:x}=u.value;H.value=e-h-x>50},D=()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight)},F=()=>{d&&(d.abort(),d=null,s.value=!1,c.value=!1)},W=()=>{_.clearMessages(),a.value=[]},G=()=>{_.loadMessages(),a.value=[..._.messages],setTimeout(D,100)},y=()=>{if(s.value){F();return}if(!n.value.trim())return;const h={from:"user",text:n.value};a.value.push(h),_.addMessage(h);const e=n.value;n.value="",s.value=!0,c.value=!1,d&&(d.abort(),d=null);const x={from:"ai",text:"",rawText:""};a.value.push(x);const v=a.value.length-1;let o="";d=new AbortController;const E=d.signal;ge({id:S.user.id,userMessage:e}).then(b=>{const L=b.body.getReader(),r=new TextDecoder("utf-8",{fatal:!1});let i="";function V(){L.read().then(({done:p,value:f})=>{if(p){console.log("流式请求完成"),i.length>0&&(console.log("处理缓冲区中剩余数据:",i),I(i),i=""),s.value=!1,c.value=!1,o&&(a.value[v].rawText=o,a.value[v].text=A.parse(o),_.addMessage({from:"ai",text:A.parse(o),rawText:o}));return}try{const l=r.decode(f,{stream:!0});console.log("接收到原始数据块:",l),i+=l,I(i),E.aborted||V()}catch(l){console.error("数据解码错误:",l),i="",E.aborted||V()}}).catch(p=>{if(p.name==="AbortError"){console.log("请求被中止"),s.value=!1,c.value=!1;return}console.error("流处理错误:",p),a.value[v].text="连接出错，请重试",s.value=!1,c.value=!1})}function I(p){const f=p.split(`

`);if(f.length>0){for(let m=0;m<f.length-1;m++){const M=f[m];N(M)}const l=f[f.length-1];l.endsWith(`
`)?(N(l),i=""):i=l}}function N(p){const f=p.split(`
`);let l=!1;for(const m of f)if(m.startsWith("data:")){const M=m.substring(5);if(M===""||M.trim()==="")console.log("接收到空行数据 - 添加换行"),o+=`
`,l=!0,c.value=!0;else{const P=M.trim();if(P){const O=P.replace(/\\n/g,`
`).replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\\\/g,"\\");console.log("解码后数据:",O),o+=O,l=!0,c.value=!0}}}else if(m.includes("event: complete")){console.log("收到完成信号"),s.value=!1,c.value=!1;return}if(l){a.value[v].rawText=o;try{a.value[v].text=A.parse(o)}catch(m){console.error("Markdown解析错误:",m),a.value[v].text=o}console.log("更新后的累积内容:",o),setTimeout(D,0)}}V()}).catch(b=>{if(b.name==="AbortError"){console.log("请求被中止");return}console.error("请求错误:",b),a.value[v].text="发送失败，请重试",s.value=!1,c.value=!1})};return le(()=>{u.value&&u.value.addEventListener("scroll",z),G()}),ne(()=>{u.value&&u.value.removeEventListener("scroll",z),d&&d.abort()}),(h,e)=>{const x=se,v=Q,o=te,E=X,b=Y,L=ee;return w(),B("div",pe,[g(L,{class:"chat-window"},{default:T(()=>[t("div",he,[t("div",_e,[g(x,{size:32,src:C(q)},null,8,["src"]),e[5]||(e[5]=t("span",null,"绿植助手",-1))]),t("div",ye,[a.value.length>0?(w(),R(v,{key:0,size:"small",type:"danger",onClick:W,class:"clear-button"},{default:T(()=>e[6]||(e[6]=[re(" 清空对话 ")])),_:1})):K("",!0),t("div",{class:U(["status-indicator",{active:s.value}])},j(s.value?c.value?"正在回复...":"思考中...":"在线"),3)])]),t("div",{class:"chat-body",ref_key:"chatBody",ref:u},[a.value.length===0?(w(),B("div",xe,[g(o,{description:"有关于植物养护的问题吗？开始和智能助手对话吧"}),t("div",be,[e[7]||(e[7]=t("div",{class:"suggestion-title"},"您可以问我这些问题:",-1)),t("div",ke,[t("div",{class:"suggestion-item",onClick:e[0]||(e[0]=r=>{n.value="如何养护多肉植物？",y()})}," 如何养护多肉植物？ "),t("div",{class:"suggestion-item",onClick:e[1]||(e[1]=r=>{n.value="我的绿萝叶子发黄是什么原因？",y()})}," 我的绿萝叶子发黄是什么原因？ "),t("div",{class:"suggestion-item",onClick:e[2]||(e[2]=r=>{n.value="适合新手种植的室内植物有哪些？",y()})}," 适合新手种植的室内植物有哪些？ "),t("div",{class:"suggestion-item",onClick:e[3]||(e[3]=r=>{n.value="植物浇水的最佳时间是什么时候？",y()})}," 植物浇水的最佳时间是什么时候？ ")])])])):(w(!0),B(ie,{key:1},ue(a.value,(r,i)=>(w(),B("div",{key:i,class:U(["message-item",r.from])},[t("div",we,[g(x,{size:40,src:r.from==="user"?C(S).user.avatar:C(q)},null,8,["src"])]),t("div",Ee,[t("div",{class:"message-text markdown-content",innerHTML:r.text},null,8,Me)])],2))),128))],512),t("div",Te,[ce(t("div",{class:"scroll-bottom-btn",onClick:D},[t("div",Ce,[g(E,null,{default:T(()=>[g(C(J))]),_:1})])],512),[[de,H.value]]),g(b,{modelValue:n.value,"onUpdate:modelValue":e[4]||(e[4]=r=>n.value=r),type:"textarea",rows:1,autosize:{minRows:1,maxRows:4},placeholder:"请输入问题...",onKeyup:ve(fe(y,["prevent"]),["enter"]),disabled:s.value,class:"custom-input"},null,8,["modelValue","onKeyup","disabled"]),g(v,{type:s.value?"danger":"primary",onClick:y,class:"custom-button"},{default:T(()=>[s.value?(w(),R(E,{key:0},{default:T(()=>[g(C(Z))]),_:1})):K("",!0),t("span",null,j(s.value?"停止":"发送"),1)]),_:1},8,["type"])])]),_:1})])}}},Ie=ae(Se,[["__scopeId","data-v-e7fe6fae"]]);export{Ie as default};
